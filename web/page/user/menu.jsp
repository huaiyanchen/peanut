<%--
  Created by IntelliJ IDEA.
  User: Administrator
  Date: 2021/5/28
  Time: 14:48
  To change this template use File | Settings | File Templates.
--%>
<%@ page contentType="text/html;charset=UTF-8" language="java" %>
<html>
<head>
    <title>ü•úüöá</title>
    <link rel="stylesheet" href="https://unpkg.com/element-ui/lib/theme-chalk/index.css">
    <script src="https://unpkg.com/vue/dist/vue.js"></script>
    <script src="https://unpkg.com/element-ui/lib/index.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/element-ui/2.15.1/index.min.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/layer/3.4.0/layer.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/qs/6.10.1/qs.js"></script>
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.js"></script>
</head>
<body>
<div id="menu">
    <el-form :inline="true" ref="myForm" class="demo-form-inline">
        <el-form-item>
            <el-button type="success" plain @click="addDialog=true">Ê∑ªÂä†ËèúÂçï</el-button>
        </el-form-item>
    </el-form>

    <el-table :data="menuList" style="width: 100%;" stripe border>
        <el-table-column prop="mid" label="Â∫èÂè∑" width="150" align="center"></el-table-column>
        <el-table-column prop="name" label="ËèúÂçïÂêç" width="150" align="center"></el-table-column>
        <el-table-column prop="parentid" label="Áà∂id" width="150" align="center" :formatter="playbackFormat2">

        </el-table-column>
        <el-table-column prop="state" label="ÊòØÂê¶ÊòæÁ§∫" width="150" align="center"
                         :formatter="playbackFormat"></el-table-column>
        <el-table-column prop="path" label="Ë∑ØÂæÑ" width="250" align="center"></el-table-column>

        <el-table-column prop="icon" label="ÂõæÊ†á" width="200" align="center"></el-table-column>

        <el-table-column label="Êìç‰Ωú" align="center" width="200">8
            <template slot-scope="scope">
                <el-button type="primary" round @click="modifyMenu(scope.row)">‰øÆÊîπ</el-button>
                <el-button type="danger" round @click="deleteCommand(scope.row.mid)"
                           :disabled="scope.row.state==0||scope.row.parentid==0">Âà†Èô§
                </el-button>
            </template>
        </el-table-column>
    </el-table>


    <!-- Ê®°ÊÄÅÊ°Ü -->
    <el-dialog title="‰øÆÊîπËèúÂçï" :visible.sync="updateDialog" width="40%">
        <el-form label-width="90px" :model="updateMenu" ref="updateMenu">
            <el-row>
                <el-form-item label="ËèúÂçïÂêç" prop="name">
                    <el-input v-model="updateMenu.name" auto-complete="off"
                              placeholder="ËØ∑ËæìÂÖ•ÂêçÁß∞"></el-input>
                </el-form-item>

                <el-form-item label="‰øÆÊîπÊòæÁ§∫" prop="state">
                    <el-input v-model="updateMenu.state" auto-complete="off"
                              placeholder="ËØ∑ËæìÂÖ•ÂêçÁß∞"></el-input>
                </el-form-item>

                <el-form-item label="ÈÄâÊã©Áà∂Á±ª" prop="parentid">
                    <el-select v-model="updateMenu.parentid" :disabled="updateMenu.parentid==0">
                        <el-option v-for="item in parents" :key="item.mid" :label="item.name" :value="item.mid">
                        </el-option>
                    </el-select>
                </el-form-item>

                <el-form-item label="ÈÄâÊã©ËßíËâ≤">
                    <el-select multiple v-model="value" placeholder="ËØ∑ÈÄâÊã©">
                        <el-option label="ÈÄâÊã©ÊâÄÊúâ" value="all"></el-option>
                        <el-option v-for="item in options" :key="item.rid" :label="item.rname" :value="item.rid">
                        </el-option>
                    </el-select>
                </el-form-item>

                <el-form-item label="‰øÆÊîπÂõæÊ†á" prop="icon">
                    <el-input v-model="updateMenu.icon" auto-complete="off"
                              placeholder="ËØ∑ËæìÂÖ•‰ΩúËÄÖ"></el-input>
                </el-form-item>
            </el-row>
        </el-form>
        <div slot="footer" class="dialog-footer">
            <el-button @click="updateDialog = false">Âèñ Ê∂à</el-button>
            <el-button type="primary" @click="modifyMenus">Á°Æ ÂÆö</el-button>
        </div>
    </el-dialog>

    <!-- Ê®°ÊÄÅÊ°Ü -->
    <el-dialog title="Ê∑ªÂä†ËèúÂçï" :visible.sync="addDialog" width="40%">
        <el-dialog width="30%" title="Ê∑ªÂä†Áà∂ËèúÂçï" :visible.sync="innerVisible1" append-to-body>
            <el-form label-width="90px" :model="addMenu" ref="addMenu">
                <el-row>
                    <el-form-item label="ËèúÂçïÂêç" prop="name">
                        <el-input v-model="addMenu.name" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•ËèúÂçïÂêç"></el-input>
                    </el-form-item>

                    <el-form-item label="Áä∂ÊÄÅ" prop="state">
                        <el-input v-model="addMenu.state" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•Áä∂ÊÄÅid"></el-input>
                    </el-form-item>
                    <el-form-item label="ÂõæÊ†á" prop="icon">
                        <el-input v-model="addMenu.icon" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•ÂõæÊ†á"></el-input>
                    </el-form-item>

                    <el-form-item label="ÈÄâÊã©ËßíËâ≤">
                        <el-select v-model="value" placeholder="ËØ∑ÈÄâÊã©">
                            <el-option v-for="item in options" :key="item.rid" :label="item.rname" :value="item.rid">
                            </el-option>
                        </el-select>
                    </el-form-item>
                </el-row>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="innerVisible1 = false ,addDialog = false">Âèñ Ê∂à</el-button>
                <el-button type="primary" @click="addMenus('parent')">Á°Æ ÂÆö</el-button>
            </div>
        </el-dialog>
        <el-dialog width="30%" title="Ê∑ªÂä†Â≠êËèúÂçï" :visible.sync="innerVisible2" append-to-body>
            <el-form label-width="90px" :model="addMenu" ref="addMenu">
                <el-row>
                    <el-form-item label="ËèúÂçïÂêç" prop="name">
                        <el-input v-model="addMenu.name" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•ËèúÂçïÂêç"></el-input>
                    </el-form-item>

                    <el-form-item label="Áä∂ÊÄÅ" prop="state">
                        <el-input v-model="addMenu.state" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•Áä∂ÊÄÅid"></el-input>
                    </el-form-item>

                    <el-form-item label="Âú∞ÂùÄ" prop="path">
                        <el-input v-model="addMenu.path" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•Ë∑ØÂæÑ"></el-input>
                    </el-form-item>

                    <el-form-item label="ÂõæÊ†á" prop="icon">
                        <el-input v-model="addMenu.icon" auto-complete="off"
                                  placeholder="ËØ∑ËæìÂÖ•ÂõæÊ†á"></el-input>
                    </el-form-item>

                    <el-form-item label="ÈÄâÊã©Áà∂Á±ª">
                        <el-select v-model="updateparentid">
                            <el-option v-for="item in parents" :key="item.mid" :label="item.name" :value="item.mid">
                            </el-option>
                        </el-select>
                    </el-form-item>

                    <el-form-item label="ÈÄâÊã©ËßíËâ≤">
                        <el-select v-model="value" placeholder="ËØ∑ÈÄâÊã©">
                            <el-option v-for="item in options" :key="item.rid" :label="item.rname" :value="item.rid">
                            </el-option>
                        </el-select>
                    </el-form-item>

                </el-row>
            </el-form>
            </el-form>
            <div slot="footer" class="dialog-footer">
                <el-button @click="innerVisible2 = false ,addDialog = false">Âèñ Ê∂à</el-button>
                <el-button type="primary" @click="addMenus('child')">Á°Æ ÂÆö</el-button>
            </div>

        </el-dialog>
        <el-button type="primary" @click="innerVisible1 = true">Ê∑ªÂä†Áà∂ËèúÂçï</el-button>
        <el-button type="primary" @click="innerVisible2 = true">Ê∑ªÂä†Â≠êËèúÂçï</el-button>
        <div slot="footer" class="dialog-footer">
            <el-button @click="addDialog = false">Âèñ Ê∂à</el-button>
        </div>
    </el-dialog>

</div>


<script type="text/javascript">
    new Vue({
        el: "#menu",
        data: {
            menuList: [],
            disabled: false,
            updateDialog: false,
            addDialog: false,
            innerVisible1: false,
            innerVisible2: false,
            options: [],
            role: {},
            menu:{},
            updateMenu: {
                mid: "",
                name: "",
                state: "",
                parentid: "",
                icon: ""
            },
            addMenu: {
                name: "",
                state: "",
                parentid: "",
                icon: "",
                path: ""
            },
            parents: [],
            value: [],
            updateparentid: '',

        },
        methods: {
            playbackFormat(row, column) {
                if (row.state === "0") {
                    return '‰∏çÊòæÁ§∫'
                } else {
                    return 'ÊòæÁ§∫'
                }
            },
            playbackFormat2(row, column) {
                let vm = this;
                if (row.parentid === 0) {
                    return 'Â∞±ÊòØÁà∂Á±ª'
                } else {
                    let arr = vm.$data.parents
                    for(j = 0,len=arr.length; j < len; j++) {
                        console.log("asdasd"+arr[1].mid)
                        if (row.parentid === arr[j].mid) {
                            console.log("asdasd"+menu.mid)
                            return arr[j].name
                        }
                    }
                }
            },
            modifyMenu(obj) {
                let vm = this;
                vm.$data.updateDialog = true;
                vm.updateMenu = obj;
            }, modifyMenus() {
                let vm = this;
                var rids = window.Qs.stringify(vm.$data.value, {arrayFormat: 'repeat'});
                let params = {
                    type: "updateMenu",
                    mid: vm.$data.updateMenu.mid,
                    name: vm.$data.updateMenu.name,
                    state: vm.$data.updateMenu.state,
                    parentid: vm.$data.updateMenu.parentid,
                    icon: vm.$data.updateMenu.icon,
                    rid: rids
                };
                console.log(params)
                axios({
                    method: "post",
                    url: "/menu.do",
                    params: params
                }).then(function (response) {
                    if (response.data === "‰øÆÊîπÊàêÂäü") {
                        vm.$data.updateDialog = false;
                        alert(response.data);
                    } else {
                        alert(response.data)
                    }
                    vm.queryMenu();
                })
            }, addMenus(obj) {
                let vm = this;
                console.log(vm.$data.updateparentid);
                let params;
                if (obj === "parent") {
                    params = {
                        type: "addMenu",
                        path: "#",
                        name: vm.$data.addMenu.name,
                        state: vm.$data.addMenu.state,
                        parentid: "0",
                        icon: vm.$data.addMenu.icon,
                        rid: vm.$data.value
                    }
                } else {
                    params = {
                        type: "addMenuChild",
                        path: vm.$data.addMenu.path,
                        name: vm.$data.addMenu.name,
                        state: vm.$data.addMenu.state,
                        icon: vm.$data.addMenu.icon,
                        parentid: vm.$data.updateparentid,
                        rid: vm.$data.value
                    }
                }
                axios({
                    method: "post",
                    url: "${path}menu.do",
                    params: params
                }).then(function (response) {
                    if (response.data === "Ê∑ªÂä†ÊàêÂäü") {
                        vm.$data.innerVisible1 = false;
                        vm.$data.innerVisible2 = false;
                        vm.$data.addDialog = false;
                        alert(response.data);
                    }
                    if (response.data === "Ê∑ªÂä†Â§±Ë¥•") {
                        alert(response.data);
                    }
                    vm.init();
                    vm.queryMenu();
                });
            },
            deleteCommand(id) {
                let vm = this
                let message;
                this.$confirm('Á°ÆÂÆöÂà†Èô§Âêó?', 'ÊèêÁ§∫', {
                    confirmButtonText: 'Á°ÆÂÆö',
                    cancelButtonText: 'ÂèñÊ∂à',
                    type: 'warning'
                }).then(() => {
                    axios({
                        method: "post",
                        url: "${path}menu.do",
                        params: {
                            type: "delete",
                            mid: id
                        }
                    }).then(function (response) {
                        message = response.data;
                        if (message == "Âà†Èô§ÊàêÂäü") {
                            console.log("1q2431241341231231")
                            vm.$data.disabled = true;
                        }
                        vm.queryMenu();
                    })
                }).catch(() => {
                    this.$message({type: 'info', message: "Â∑≤ÂèñÊ∂àÈÄÄÂá∫"});
                });
            }, queryMenu(params) {
                let vm = this;
                if (params == null) {
                    params = {
                        type: "show"
                    }
                }
                axios({
                    method: "post",
                    url: "/menu.do",
                    params: params
                }).then(function (response) {
                    vm.$data.menuList = response.data;
                })
            }, init() {
                //ÂàùÂßãÂåñÈ°µÈù¢Êï∞ÊçÆÁöÑÊñπÊ≥ï
                let vm = this;
                axios({
                    method: "post",
                    url: "/menu.do",
                    params: {
                        type: "showParents"
                    }
                }).then(function (response) {
                    vm.$data.parents = response.data;
                })  , axios({
                    method: "post",
                    url: "/role.do",
                    params: {
                        type: "showRole"
                    }
                }).then(function (response) {
                    vm.$data.options = response.data;
                })

            },
        },
        mounted() {
            let vm = this;
            vm.queryMenu();
            vm.init();

        }, watch: {
            value: function (val, oldval) {
                let newindex = val.indexOf('all'), oldindex = oldval.indexOf('all');   //Ëé∑ÂèñvalÂíåoldvalÈáåallÁöÑÁ¥¢Âºï,Â¶ÇÊûúÊ≤°ÊúâÂàôËøîÂõû-1
                if (newindex != -1 && oldindex == -1 && val.length > 1)                       //Â¶ÇÊûúÊñ∞ÁöÑÈÄâÊã©ÈáåÊúâÂãæÈÄâ‰∫ÜÈÄâÊã©ÊâÄÊúâÈÄâÊã©ÊâÄÊúâ Âàô Âè™Áõ¥Á∫øÂãæÈÄâÊâÄÊúâÊï¥‰∏™ÈÄâÈ°π
                    this.value = ['all'];
                else if (newindex != -1 && oldindex != -1 && val.length > 1)                 //Â¶ÇÊûúÊìç‰ΩúÂâçÊúâÂãæÈÄâ‰∫ÜÈÄâÊã©ÊâÄÊúâ‰∏îÂΩìÂâç‰πüÈÄâ‰∏≠‰∫ÜÂãæÈÄâÊâÄÊúâ‰∏îÂãæÈÄâÊï∞ÈáèÂ§ß‰∫é1  ÂàôÁßªÈô§ÊéâÂãæÈÄâÊâÄÊúâ
                    this.value.splice(val.indexOf('all'), 1)
            }
        }
    })
</script>
</body>
</html>
